---
layout: post
category: 监控
title: 系统监控指标
tagline: by 噜噜噜
tags: 
  - xx
published: true
---



<!--more-->

### 一、四个黄金指标

##### 1、延迟

​	服务请求所需时间，重点是要区分`成功请求的延迟时间`和`失败请求的延迟时间`

##### 2、通讯量

​	监控当前系统的流量，用于衡量服务的容量需求

​	流量对于不同类型的系统而言可能代表不同的含义。例如，在HTTP REST API中, 流量通常是每秒HTTP请求数

##### 3、错误

​	监控当前系统所有发生的错误请求，衡量当前系统错误发生的速率

​	对于失败而言有些是显式的(比如, HTTP 500错误)，而有些是隐式(比如，HTTP响应200，单实际业务流程依然是失败的)。

​	对于一些显式的错误如HTTP 500可以通过在负载均衡器(如Nginx)上进行捕获，而对于一些系统内部的异常，则可能需要直接从服务中添加钩子统计并进行获取

##### 4、饱和度

​	衡量当前服务的饱和度

​	主要强调最能影响服务状态的受限制的资源。 例如，如果系统主要受内存影响，那就主要关注系统的内存状态，如果系统主要受限与磁盘I/O，那就主要观测磁盘I/O的状态

### 二、USE方法

#### 1、指标解释

USE方法全称"Utilization Saturation and Errors Method"，主要用于分析系统性能问题，可以指导用户快速识别资源瓶颈以及错误的方法

##### ①使用率

​	**基于时间**：基于时间的使用率是使用排队理论做正式定义的。

​						U = B/T  （U是使用率，B是T时间内系统的繁忙时间）

​	**基于容量**：一般用来磁盘/内存等设备

##### ②饱和度 

​	随着工作量增加而对资源的请求超过资源所能处理的程度叫做饱和度	

​	**基于容量:** (任何程度的饱和度都是性能问题)

​		饱和度发生在容量100%使用率时,这是过多的功能无法处理,开始排队

​		![](https://s3.ax1x.com/2020/12/01/DfbP7F.png)

​	**基于时间:**

​		排队和饱和度可能不发生在100%使用率时候,取决于资源处理任务的并行能力

##### ③错误

​	错误计数。例如：“网卡在数据包传输过程中检测到的以太网网络冲突了14次”

#### 2、流程图

USE方法的流程图，**错误被置于检查首位，要先于使用率和饱和度**

![](https://s3.ax1x.com/2020/12/01/DfgErR.png)

#### 3、常见的指标分类及检查清单

| 模块       | 类型   | 指标                                                         |
| ---------- | ------ | ------------------------------------------------------------ |
| CPU        | 利用率 | `每个CPU：`mpstat -P ALL（%idle）;sar -P ALL（%idle）<br />`系统范围`：vmstat 1（id项）；sar -u（%idle）<br />`每个进程`：top（%cpu项）；pidstat 1（%CPU项） |
| CPU        | 饱和度 | `系统范围`：vmstat 1 （r > CPU数量）；sar -q（runq-sz > cpu数量）<br />`每个进程`：perf sched record(先收集) perf sched latency --sort max |
| 内存       | 利用率 | `系统范围`: free -m ; vmstat 1<br />`每个进程`: top (RES项 驻留主存   VIRT项 虚存   %MEM项为系统范围内的总计) |
| 内存       | 饱和度 | `系统范围`: vmstat 1 (si/so项)<br />`每个进程`: htop(MINFLT一项) 来查看谁造成了次要缺页; dmesg \|grep killed |
| 内存       | 错误   | dmesg可以得到物理失效; 动态追踪Dtrace/SystemTap              |
| 网络接口   | 利用率 | sar -n DEV (rxkB/s txkB/s 除以最大带宽)                      |
| 网络接口   | 饱和度 | sar -n EDEV(rxdrop/s txdrop/s)                               |
| 网络接口   | 错误   | ifconfig (errors 选项 dropped项)                             |
| 存储设备IO | 利用率 | `系统范围`: iostat -xz 1 (%utils项)  ;sar -d (%utils项)<br />`每个进程`: iotop |
| 存储设备IO | 饱和度 | iostat -xz 1 (avgqu-sz > 1或者较高的await) ; sar -d          |
| 存储设备IO | 错误   | smartctl                                                     |



### 三、RED方法

RED方法是Weave Cloud在基于Google的“4个黄金指标”的原则下结合Prometheus以及Kubernetes容器实践，细化和总结的方法论，特别适合于云原生应用以及微服务架构应用的监控和度量。主要关注以下三种关键指标：

- (请求)速率：服务每秒接收的请求数。
- (请求)错误：每秒失败的请求数。
- (请求)耗时：每个请求的耗时。