---
layout: post
category: Linux
title: ssh端口转发功能
tagline: by 噜噜噜
tags: 
  - xx
published: true
---



<!--more-->

# ssh端口转发功能介绍

将TCP 端口的网络数据，转发到指定的主机某个端口上，在转发的同时会对数据进行相应的加密及解密

### 转发参数

```
-C：压缩数据
-f ：后台认证用户/密码，通常和-N连用，不用登录到远程主机。
-N ：不执行脚本或命令，通常与-f连用。
-g ：在-L/-R/-D参数中，允许远程主机连接到建立的转发的端口，如果不加这个参数，只允许本地主机建立连接。
-L : 本地端口:目标IP:目标端口
-D : 动态端口转发
-R : 远程端口转发
-T ：不分配 TTY 只做代理用
-q ：安静模式，不输出 错误/警告 信息
```

### 本地转发

有本地网络服务器的某个端口，转发到远程服务器某个端口。说白了就是，将发送到本地端口的请求，转发到目标端口

格式如下：

ssh -L 本地网卡地址:本地端口:目标地址:目标端口 用户@目标地址。

现在我们利用本地转发来解决一个问题，比如我们有两台机器，如下：

centos A（192.168.13.139）

centos B（192.168.13.142）

现在，centos B（192.168.13.142）机器上面安装了mysql，并设置了运行任何主机连接，如下：

![34324](https://i.loli.net/2020/08/07/iMkAwDymxB49OeK.png)

此时，在centos A（192.168.13.139）上面是可以连上centos B（192.168.13.142）的mysql，如下：

![4342](https://i.loli.net/2020/08/07/q9IztpeLoc1lxrd.png)

那么，现在我开始centos B（192.168.13.142）限制不允许外部ip连接，仅仅让127.0.0.1连接，如下：

![134](https://i.loli.net/2020/08/07/AZEmxrYV72kT5BI.png)

此时，centos A（192.168.13.139）上面怎么连接上centos B（192.168.13.142）的mysql呢？

这个时候，我们就可以使用本地端口转发了，将本地的某个端口，映射到centos B（192.168.13.142）机器上面的，如下：

```
ssh -L 127.0.0.1:3306:127.0.0.1:3306 root@192.168.13.142
```

因为本地网卡地址是可以省略的，上面的转发，可以简写为：

```
ssh -L 3306:127.0.0.1:3306 root@192.168.13.142
```

当然，ssh连接的时候，若两台机器的用户名相同，也是可以省略的，即命令可以简写为：

```
ssh -L 3306:127.0.0.1:3306 192.168.13.14
```

上面的代码就是将本地的3306端口，转发到192.168.13.142的3306端口。因为centos B（192.168.13.142）上面的mysql使用的3606端口。当然，我们首先得看看本地的3306端口是否被占用，如被占用，可以使用其他的端口。



数据流向如图：

![1323](https://i.loli.net/2020/08/07/KsBctjJ9ea2ioLh.png)

首先，centos A（192.168.13.139）上的应用将数据发送到本地的127.0.0.1上面的3306端口。

然后，centos A（192.168.13.139）将3306端口的数据，通过SSH转发到centos B（192.168.13.142）的3306端口。

接着，centos B（192.168.13.142）将处理后的数据，原路返回给centos A（192.168.13.139）。

如果是首次通过ssh连接cetosB该机器，则会提示确认公钥，并让你选择是否确定连接

![12](https://i.loli.net/2020/08/07/bP72GLjUiwAqKEp.png)

此时，我们在centos A上面连接centos B上面的mysql，就可以这么写了

```
/bin/mysql -h127.0.0.1 -uroot -p
```

![123](https://i.loli.net/2020/08/07/kW5VKNQsZieXr8z.png)



### 远程转发

由远程服务器的某个端口，转发到本地网络的服务器某个端口。说白了，就是将发送到远程端口的请求，转发到目标端口。格式如下：

```
ssh -R 远程网卡地址:远程端口:目标地址:目标端口
```

下面三台机器为例，如下：

centos A（192.168.13.139）

centos B（192.168.13.142）

win7（10.18.78.135）

假设，win7（10.18.78.135）与centos B（192.168.13.142）不能直接连接，但是win7（10.18.78.135）与centos A（192.168.13.139）可以连接centos B（192.168.13.142）也可以centos A（192.168.13.139）连接，那么，我们就可以在centos A（192.168.13.139）上面使用远程端口转发了，让win7（10.18.78.135）与centos B（192.168.13.142）进行通信

```
ssh -R 127.0.0.1:80:10.18.78.135:80 root@192.168.13.142
```

即centos B（192.168.13.142）监听自己的80端口，然后将所有数据，由centos A（192.168.13.139）发给win7（10.18.78.135）。

