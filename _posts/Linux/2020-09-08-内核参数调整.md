---
layout: post
category: Linux
title: 内核参数配置
tagline: by 噜噜噜
tags: 
  - xx
published: true
---

<!--more-->

Linux系统下，TCP连接断开后，会以TIME_WAIT状态保留一定的时间，然后才会释放端口。当并发请求过多的时候，就会产生大量的TIME_WAIT状态的连接，无法及时断开的话，会占用大量的端口资源和服务器资源。这个时候我们可以优化TCP的内核参数，来及时将TIME_WAIT状态的端口清理掉。

### 一、内核参数说明

Linux在系统运行时修改内核参数(/proc/sys与/etc/sysctl.conf)，而不需要重新引导系统，这个功能是通过/proc虚拟文件系统实现的

/proc/sys下内核文件与配置文件sysctl.conf中变量的对应关系：

**由于可以修改的内核参数都在/proc/sys目录下，所以sysctl.conf的变量名省略了目录的前面部分（/proc/sys）**

即将/proc/sys中的文件转换成sysctl中的变量依据下面两个简单的规则：

1．去掉前面部分/proc/sys

2．将文件名中的斜杠变为点

这两条规则可以将/proc/sys中的任一文件名转换成sysctl中的变量名

例如：

```
/proc/sys/net/ipv4/ip_forward ＝》 net.ipv4.ip_forward
/proc/sys/kernel/hostname ＝》 kernel.hostname
```

可以使用下面命令**查询所有可修改的变量名**

```
# sysctl –a
```



### 二、具体参数

根据参数文件所处目录不同而进行分表整理

下列文件所在目录：**/proc/sys/net/ipv4/**

| 名称                      | 默认值                  | 建议值                | 描述                                                         |
| ------------------------- | ----------------------- | --------------------- | ------------------------------------------------------------ |
| **tcp_syn_retries**       | 5                       | 1                     | 对于一个新建连接，内核要发送多少个 SYN 连接请求才决定放弃。不应该大于255，默认值是5，对应于180秒左右时间(对于大负载而物理通信良好的网络而言,这个值偏高,可修改为2.**这个值仅仅是针对对外的连接**,对进来的连接,是由**tcp_retries1**决定的) |
| **tcp_synack_retries**    | 5                       | 1                     | 对于远端的连接请求SYN，内核会发送SYN ＋ ACK数据报，以确认收到上一个 SYN连接请求包。这是所谓的三次握手( threeway handshake)机制的第二个步骤。这里决定内核**在放弃连接之前所送出的 SYN+ACK 数目**。不应该大于255，默认值是5，对应于180秒左右时间 |
| **tcp_keepalive_time**    | 7200                    | 600                   | TCP发送keepalive探测消息的间隔时间（秒），用于确认TCP连接是否有效。防止两边建立连接但不发送数据的攻击 |
| **tcp_keepalive_probes**  | 9                       | 3                     | TCP发送keepalive探测消息的最大数量，用于确认TCP连接是否有效  |
| **tcp_keepalive_intvl**   | 75                      | 15                    | The number of seconds between TCP keep-alive probes          |
| **tcp_retries1**          | 3                       | 3                     | 放弃回应一个TCP连接请求前﹐需要进行多少次重试。RFC规定最低的数值是3 |
| **tcp_retries2**          | 15                      | 5                     | 在丢弃激活(已建立通讯状况)的TCP连接之前﹐需要进行多少次重试。**默认值为15，根据RTO的值来决定，相当于13-30分钟**(RFC1122规定，必须大于100秒).(这个值根据目前的网络设置,可以适当地改小,我的网络内修改为了5) |
| **tcp_orphan_retries**    | 7                       | 3                     | 在近端丢弃TCP连接之前﹐要进行多少次重试。默认值是7个﹐相当于 50秒 – 16分钟﹐视 RTO 而定。**如果您的系统是负载很大的web服务器﹐那么也许需要降低该值﹐这类 sockets 可能会耗费大量的资源**。另外参的考 tcp_max_orphans 。(事实上做NAT的时候,降低该值也是好处显著的,我本人的网络环境中降低该值为3) |
| **tcp_fin_timeout**       | 60                      | 2                     | 对于本端断开的socket连接，TCP保持在FIN-WAIT-2状态的时间。对方可能会断开连接或一直不结束连接或不可预料的进程死亡。默认值为 60 秒。如果您的机器为负载很重的web服务器﹐您可能要冒内存被大量无效数据报填满的风险 |
| **tcp_max_tw_buckets**    | 180000                  | 36000                 | 系统同时保持TIME_WAIT的最大数量，如果超过这个数字，TIME_WAIT将立刻被清除并打印警告信息.之所以要设定这个限制﹐**纯粹为了抵御那些简单的 DoS 攻击﹐千万不要人为的降低这个限制** |
| **tcp_tw_recycle**        | 0                       | 1                     | 打开快速 TIME-WAIT sockets 回收。**除非得到技术专家的建议或要求﹐请不要随意修改这个值** |
| **tcp_tw_reuse**          | 0                       | 1                     | 表示是否允许重新应用处于TIME-WAIT状态的socket用于新的TCP连接(**这个对快速重启动某些服务,而启动后提示端口已经被使用的情形非常有帮助**) |
| **tcp_max_orphans**       | 8192                    | 32768                 | 系统所能处理不属于任何进程的TCP sockets最大数量。假如超过这个数量﹐那么不属于任何进程的连接会被立即reset，并同时显示警告信息。**之所以要设定这个限制﹐纯粹为了抵御那些简单的 DoS 攻击﹐千万不要依赖这个或是人为的降低这个限制** |
| **tcp_abort_on_overflow** | 0                       | 0                     | 当守护进程太忙而不能接受新的连接，就象对方发送reset消息，默认值是false。这意味着当溢出的原因是因为一个偶然的猝发，那么连接将恢复状态。**只有在你确信守护进程真的不能完成连接请求时才打开该选项，该选项会影响客户的使用** |
| **tcp_syncookies**        | 0                       | 1                     | 只有在内核编译时选择了CONFIG_SYNCOOKIES时才会发生作用。当出现syn等候队列出现溢出时向对方发送syncookies。目的是为了防止syn flood攻击。**该选项千万不能用于那些没有收到攻击的高负载服务器，syncookie严重的违背TCP协议，不允许使用TCP扩展，可能对某些服务导致严重的性能影响(** |
| **tcp_stdurg**            | 0                       | 0                     | 使用 TCP urg pointer 字段中的主机请求解释功能。大部份的主机都使用老旧的 BSD解释，因此如果您在 Linux 打开它﹐或会导致不能和它们正确沟通。 |
| **tcp_max_syn_backlog**   | 1024                    | 16384                 | SYN队列的长度，默认为1024，加大队列长度为16384，可以容纳更多等待连接的网络连接数 |
| **tcp_wmem**              | 4096    16384   4194304 | 8192  131072 16777216 | 发送缓存设置 ，分别为最小、默认、最大                        |
| **tcp_rmem**              | 4096    87380   6291456 |                       | 接收缓存设置                                                 |
| **tcp_mem**               | 88500   118001  177000  |                       | 一般情况下这些值是在系统启动时根据系统内存数量计算得到的     |
| **ip_forward**            | 0                       |                       | **NAT必须开启IP转发支持，把该值写1**                         |
| **ip_local_port_range**   | 32768   60999           | 1024            65000 | 表示用于向外连接的端口范围，默认比较小，这个范围同样会间接用于NAT表规模。 |



#### 1、swappiness

在CentOS、Red Hat、ubuntu等系统中，**swappiness的默认值都为60**，如果Linux服务器的内存很小，比如说低于4G，那么可以不用更改这个值，因为毕竟考虑到内存不够用而去借用swap的情况。而相对于很多服务器来说，目前还是建议设置在值为25以下，如果超过了8G内存，而且目前内存使用量还有剩余的话，建议直接将swappiness改成0，这样可以最大限度的使用物理内存，减少硬盘的负载，同时加快速度

查看当前值：

```
cat /proc/sys/vm/swappiness
```

临时调整：

```
sysctl vm.swappiness=10
```

永久调整：

#vi /etc/sysctl.conf

```
vm.swappiness=10
```

\#sysctl -p



#### 





#### 参考：http://www.ha97.com/4396.html