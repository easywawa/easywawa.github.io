---
layout: post
category: openstack
title: cpu多核心、超线程技术解析
tagline: by 噜噜噜
tags: 
  - xx
published: true
---



<!--more-->

### 一、cpu介绍

#### 1、种类

常见的五种英特尔消费级CPU：

- 赛扬是双核，不支持超线程 - 入门玩家
- 奔腾是双核，不支持超线程 - 中低端玩家
- i3是双核，支持超线程 - 中端玩家
- i5是4核，不支持超线程 - 中高端玩家
- i7是4核，支持超线程 - 高端玩家

企业级处理器CPU：

- Xeon(志强)

#### 2、架构

CPU中两个相关的模块：

- Processing Unit（运算处理单元），简称PU,执行运算，比如算数运算加减乘除
- Architectual State（架构状态单元），简称AS,执行一些逻辑和调度方面的操作，比如控制内存访问等

`比喻：一个小饭馆（单核CPU），夫妻老婆店，老板兼大厨厨房炒菜，老板娘兼服务员点单。这不，来了一个客人，首先，走到老板娘的收银台前，看菜单准备点单。差不多5分钟后，客人点完了一份盖浇饭。老板娘抄好了单，递给了在后厨的老公。老公开始炒菜。在这个例子中，老板娘可以理解成AS，老板/大厨可以理解称PU（干实事的）`

##### ①单核CPU

一般一块传统意义的CPU上会有一个PU、一个AS

##### ②多核CPU

这里说的多核，是多个物理核

`比喻：有4个服务生、4个大厨。4个服务生同时点单，4个大厨同时开炒，这里会有一个效率的问题，每个客人点单的时间不一样，会造成有的大厨很闲，这时候的解决办法就是增加服务生，2个服务生对应一个大厨，这就是超线程的理念`

##### ③超线程技术HT

超线程(HT)并不是我们一般说的多线程。我们一般说的多线程（multi-threading）是指程序方面的，简单的说就是‘软’的，代码级别的。而超线程一般指的是硬件架构方面的，是‘硬’的**：通过调整AS而模拟出来的‘逻辑核’**。

超线程就是一个物理核里面，有两个AS，一个PU。**两个AS共享一个PU**

![img](https://images2017.cnblogs.com/blog/172889/201707/172889-20170727144934430-1114354683.jpg)

#### 3、cpu使用率比较

在下图中，橙色和蓝色表明大厨（PU/CPU）是在工作的，白色格子表明大厨（PU）是空闲的

A图是单核没有没有用超线程，B图双核没有超线程，图C是单核启用了超线程

![img](https://images2017.cnblogs.com/blog/172889/201707/172889-20170727144952165-2075845464.jpg)

**一般理论上，超线程总体性能提高差不多20%-30%。但是也有缺点。**

### 二、超线程的缺点

- 单核性能下降
  - 一般在5%-15%之间，主要表现在运行单线程程序，两个AS的额外开销比一个AS的开销要大（系统调度程序选择AS的过程）
- 电费增加
  - 一般功耗平均上升30%
- 阻塞
  - 操作系统会安排程序检查AS的队列，哪个队列少则使用哪个AS。这样也会浪费时间造成性能损失
- 老系统支持差



**总结：**

超线程技术并非万能药。从 Intel 和 VMware 对外公开的资料看，开启超线程后，Core 的总计算能力是否提升以及提升的幅度和业务模型相关，平均提升在 20%-30% 左右。但超线程对 Core 的执行资源的争抢，业务的执行时延也会相应增加。当超线程相互竞争时，超线程的计算能力相比不开超线程时的物理核甚至会下降 30% 左右。所以，超线程应该关闭还是开启，主要还是取决于应用模型

### 三、使用场景

- 对于时延敏感型任务，比如用户需要及时响应任务运行结果的场景，在节点负载过高，引发超线程竞争时，任务的执行时长会显著增加，导致影响用户体验。所以，不推荐计算密集型和时延敏感型任务使用超线程技术
- 对于后台计算型任务，它不要求单个任务的响应速度，比如超算中心上运行的后台计算型任务（一般要运行数小时或数天），就建议开启超线程来提高整个计算节点的吞吐量



