---
layout: post
category: openstack
title: 虚拟机跨租户迁移
tagline: by 噜噜噜
tags: 
  - xx
published: true
---



<!--more-->

# 方法1：（已验证）

### 一、备份数据库

```
docker exec -it -u root mariadb mysqldump -uroot -pxxxxxxxxxxx nova instances > nova_instances.sql 

docker exec -it -u root mariadb mysqldump -uroot -pxxxxxxxxxxx neutron floatingips  > neutron_floatingips.sql 
```



### 二、更改nova数据库

```
use nova;

select project_id,reservation_id,display_name from instances where project_id=’old-xxxxx’;

update instances set project_id=’new-xxxxxxxxxx’ where reservation_id=’上面查到的id’;
```

此时虚拟机已经出现在B项目中

### 三、更改neutron数据库

#更改浮动ip的租户

```
use neutron;
update floatingips set project_id='new-xxxxxxxxxx' where floating_ip_address='xxxxxxxxxxx';
```



### 四、操作虚拟机

#进入虚拟机删除网卡配置文件

```
rm /etc/udev/rules.d/70-xxxxxxxxxx 
```

**##将原来的interface解绑并绑定新的interface**

**##reboot**





# 方法2：（未验证）

### 一、面板或者后台修改网络类型为共享网络

```
openstack network set xxxxxxx --share
```

### 二、备份数据库

```
docker exec -it -u root mariadb mysqldump -uroot -pxxxxxxxxxxx nova instances > nova_instances.sql 

docker exec -it -u root mariadb mysqldump -uroot -pxxxxxxxxxxx nova instance_info_caches > nova_instance_info_caches.sql 

docker exec -it -u root mariadb mysqldump -uroot -pxxxxxxxxxxx cinder volumes > cinder_volumes.sql 

docker exec -it -u root mariadb mysqldump -uroot -pxxxxxxxxxxx neutron ports > neutron_ports.sql
```

### 三、查找原来项目的user_id和project_id，并记录下来

```
openstack user list --long 

openstack project list --long
```

### 四、查找目标项目的user_id和project_id

```
openstack user list --long 

openstack project list --long
```

### 五、修改数据库

```
mysql> update nova.instances set user_id="xxxxxxx",project_id="xxxxxxxx" where project_id="XXXXXXX"; 

mysql> update cidner.volumes set user_id="xxxxxxx",project_id="xxxxxxxx" where project_id="XXXXXXX"; 

mysql> update neutron.ports set user_id="xxxxxxx",project_id="xxxxxxxx" where project_id="XXXXXXX";
```

### 六、将导出来的nova.instance_info_caches.sql导出来，进行修改替换project_id 为目标项目id

//将数据库表导入 docker cp nova_instance_info_caches.sql mariadb:/opt/ 

```
mysql> use nova; 

mysql[nova]>source /opt/nova_instance_info_caches.sql
```

